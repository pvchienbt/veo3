<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng C·ª• T·∫°o Prompt VEO 3 T·ª± ƒê·ªông</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .prompt-box { background-color: #e2e8f0; border-radius: 0.5rem; padding: 1rem; overflow-x: auto; }
        .scene-card { border-left: 4px solid #3b82f6; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-left-color: #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .preview-item { max-height: 100px; width: auto; border-radius: 0.5rem; object-fit: cover; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-6 text-center">
            C√¥ng C·ª• T·∫°o Prompt Video VEO 3 (Gemini AI)
        </h1>
        <div class="card p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">1. Nh·∫≠p √ù T∆∞·ªüng Video & ƒêa Ph∆∞∆°ng Ti·ªán</h2>
            
            <!-- Input Form -->
            <div class="space-y-4">
                <div>
                    <label for="videoIdea" class="block text-sm font-medium text-gray-700 mb-1">T√≥m t·∫Øt √ù t∆∞·ªüng (V√≠ d·ª•: M·ªôt c√¥ g√°i vƒÉn ph√≤ng th·∫•t nghi·ªáp b·∫Øt ƒë·∫ßu kinh doanh b√°nh m√¨)</label>
                    <textarea id="videoIdea" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="Vi·∫øt √Ω t∆∞·ªüng c·ªßa b·∫°n v√†o ƒë√¢y..."></textarea>
                </div>
                
                <!-- Image Upload -->
                <div class="border-t border-gray-200 pt-4">
                    <label for="imageUpload" class="block text-sm font-medium text-gray-700 mb-1">
                        T·∫£i l√™n H√¨nh ·∫£nh M√¥ t·∫£ (T√πy ch·ªçn - D√πng l√†m NGU·ªíN CH√çNH X√ÅC 100% cho h√¨nh ·∫£nh)
                    </label>
                    <input type="file" id="imageUpload" accept="image/*" multiple class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                    <div id="imagePreviewContainer" class="mt-3 flex flex-wrap gap-2 justify-center p-3 border border-dashed border-gray-300 rounded-lg hidden">
                        <!-- Image previews will be injected here -->
                    </div>
                </div>

                <!-- Ch·ª©c nƒÉng t·∫£i l√™n Gi·ªçng n√≥i ƒë√£ b·ªã lo·∫°i b·ªè ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh ·ªïn ƒë·ªãnh -->

                <div>
                    <label for="numScenes" class="block text-sm font-medium text-gray-700 mb-1">S·ªë Ph√¢n C·∫£nh (T·ªëi thi·ªÉu 1, t·ªëi ƒëa 100)</label>
                    <input type="number" id="numScenes" value="4" min="1" max="100" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                </div>
            </div>

            <button id="generateBtn" 
                    class="mt-6 w-full flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-xl text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 disabled:opacity-50">
                <span id="btnText">T·∫°o K·ªãch B·∫£n & Prompt</span>
                <div id="loadingSpinner" class="spinner ml-3 hidden"></div>
            </button>
        </div>

        <!-- Output Display Area -->
        <div id="outputSection" class="hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">2. K·∫øt Qu·∫£ K·ªãch B·∫£n & Prompt</h2>
            <div id="videoTitleDisplay" class="text-xl font-semibold mb-4 p-3 bg-indigo-100 text-indigo-800 rounded-lg shadow-inner"></div>
            <div id="scenesContainer" class="space-y-6">
                <!-- Scenes will be injected here -->
            </div>
        </div>

        <!-- Error/Message Display -->
        <div id="messageArea" class="hidden mt-6 p-4 text-sm rounded-lg bg-red-100 text-red-700" role="alert"></div>
    </div>

    <script type="module">
        // Import c√°c module Firebase c·∫ßn thi·∫øt (Kh√¥ng thay ƒë·ªïi)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // C·∫•u h√¨nh API v√† Firebase
        const apiKey = "AIzaSyDq3M4VIxG8XgLzjYqDsUiV2Yvp0ukLPvM"; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        let db, auth;
        setLogLevel('debug'); 

        // Kh·ªüi t·∫°o Firebase (Kh√¥ng thay ƒë·ªïi)
        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            if (initialAuthToken) {
                signInWithCustomToken(auth, initialAuthToken).catch(error => {
                    console.error("Firebase Custom Token Sign-In failed:", error);
                    signInAnonymously(auth); 
                });
            } else {
                signInAnonymously(auth);
            }
        } else {
            console.warn("Firebase config not available. App will function without persistence.");
        }

        // --- UI Element Selectors ---
        const generateBtn = document.getElementById('generateBtn');
        const videoIdeaInput = document.getElementById('videoIdea');
        const numScenesInput = document.getElementById('numScenes');
        const imageUpload = document.getElementById('imageUpload');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const btnText = document.getElementById('btnText');
        const outputSection = document.getElementById('outputSection');
        const videoTitleDisplay = document.getElementById('videoTitleDisplay');
        const scenesContainer = document.getElementById('scenesContainer');
        const messageArea = document.getElementById('messageArea');

        // --- Helper Function: Convert File to Base64 (Robust) ---
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                if (!file) return reject(new Error("File object is missing."));
                
                // Gi·ªõi h·∫°n k√≠ch th∆∞·ªõc file an to√†n (10MB) cho c√°c y√™u c·∫ßu Multimodal
                if (file.size > 10 * 1024 * 1024) { 
                    return reject(new Error(`T·ªáp "${file.name}" qu√° l·ªõn (max 10MB).`));
                }

                const reader = new FileReader();
                reader.onload = () => {
                    try {
                        const base64Data = reader.result.split(',')[1];
                        if (!base64Data) {
                            throw new Error("Base64 data extraction failed.");
                        }
                        resolve({
                            data: base64Data,
                            mimeType: file.type
                        });
                    } catch (e) {
                        reject(new Error(`Conversion error for file ${file.name}: ${e.message}`));
                    }
                };
                reader.onerror = error => reject(new Error(`FileReader error for file ${file.name}: ${error.target.error.code}`));
                reader.readAsDataURL(file);
            });
        }

        // --- Event Listener for Image Preview (Updated for multiple files) ---
        imageUpload.addEventListener('change', function() {
            imagePreviewContainer.innerHTML = ''; // Clear previous previews
            const files = this.files;
            if (files.length > 0) {
                imagePreviewContainer.classList.remove('hidden');
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'preview-item object-cover h-24 w-auto border border-gray-200 rounded-md shadow-md'; 
                        img.alt = 'H√¨nh ·∫£nh xem tr∆∞·ªõc';
                        imagePreviewContainer.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                });
            } else {
                imagePreviewContainer.classList.add('hidden');
            }
        });
        
        // --- C·∫•u tr√∫c JSON b·∫Øt bu·ªôc cho Gemini (Rule 7) ---
        const responseSchema = {
            type: "OBJECT",
            properties: {
                "video_title": { "type": "STRING", "description": "T√™n h·∫•p d·∫´n cho video b·∫±ng ti·∫øng Vi·ªát." },
                "scenes": {
                    "type": "ARRAY",
                    "description": "M·∫£ng c√°c ph√¢n c·∫£nh, m·ªói c·∫£nh t·ªëi ƒëa 8 gi√¢y v√† ƒë·∫£m b·∫£o t√≠nh li√™n t·ª•c 100% v·ªÅ h√¨nh ·∫£nh v√† nh√¢n v·∫≠t.",
                    "items": {
                        "type": "OBJECT",
                        "properties": {
                            "scene_number": { "type": "NUMBER" },
                            "duration_seconds": { "type": "STRING", "description": "Lu√¥n l√† '8s'" },
                            "vietnamese_script": { "type": "STRING", "description": "M√¥ t·∫£ chi ti·∫øt h√†nh ƒë·ªông v√† l·ªùi tho·∫°i b·∫±ng ti·∫øng Vi·ªát." },
                            "veo_prompt_en": { "type": "STRING", "description": "Prompt ti·∫øng Anh cho VEO 3. B·∫ÆT BU·ªòC b·∫Øt ƒë·∫ßu b·∫±ng vi·ªác L·∫∂P L·∫†I TO√ÄN B·ªò m√¥ t·∫£ b·ªëi c·∫£nh v√† nh√¢n v·∫≠t ƒë√£ ƒë∆∞·ª£c t·∫°o trong C·∫£nh 1. T·∫§T C·∫¢ l·ªùi tho·∫°i B·∫ÆT BU·ªòNG l√† ti·∫øng Vi·ªát v√† c√≥ m√¥ t·∫£ gi·ªçng n√≥i c·ªë ƒë·ªãnh 100%." }
                        },
                        "required": ["scene_number", "duration_seconds", "vietnamese_script", "veo_prompt_en"]
                    }
                }
            },
            "required": ["video_title", "scenes"]
        };


        // --- Quy t·∫Øc B·∫ÆT BU·ªòNG (System Instruction) - T√çNH ƒê·ªíNG NH·∫§T 100% GI·ªåNG N√ìI ƒê√É ƒê∆Ø·ª¢C √âP BU·ªòC ---
        const systemInstructionText = `
            B·∫°n l√† m·ªôt chuy√™n gia s√°ng t·∫°o k·ªãch b·∫£n video chuy√™n nghi·ªáp. Nhi·ªám v·ª• c·ªßa b·∫°n l√† x√¢y d·ª±ng m·ªôt k·ªãch b·∫£n video chi ti·∫øt v√† chuy·ªÉn n√≥ th√†nh m·ªôt chu·ªói c√°c prompt ti·∫øng Anh s·∫µn s√†ng ƒë·ªÉ ƒë∆∞a v√†o c√°c m√¥ h√¨nh AI t·∫°o video (nh∆∞ Veo 3).

            C√°c quy t·∫Øc B·∫ÆT BU·ªòC v√† ƒê√É ƒê∆Ø·ª¢C C·∫¢I TI·∫æN ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh ƒë·ªìng nh·∫•t 100%:
            1. Video ph·∫£i ƒë∆∞·ª£c chia th√†nh nhi·ªÅu PH√ÇN C·∫¢NH (SCENE).
            2. M·ªñI PH√ÇN C·∫¢NH c√≥ ƒë·ªô d√†i T·ªêI ƒêA l√† 8 GI√ÇY.
            3. PH·∫¢I ƒë·∫£m b·∫£o T√çNH LI√äN T·ª§C 100% v·ªÅ b·ªëi c·∫£nh, ngo·∫°i h√¨nh, trang ph·ª•c, v√† phong c√°ch h√¨nh ·∫£nh (style) gi·ªØa t·∫•t c·∫£ c√°c ph√¢n c·∫£nh.
            4. M·ªñI PH√ÇN C·∫¢NH PH·∫¢I ƒë∆∞·ª£c vi·∫øt th√†nh 1 PROMPT TI·∫æNG ANH ƒê·ªòC L·∫¨P.
            5. PROMPT TI·∫æNG ANH c·ªßa m·ªói ph√¢n c·∫£nh PH·∫¢I B·∫ÆT ƒê·∫¶U b·∫±ng vi·ªác L·∫∂P L·∫†I TO√ÄN B·ªò M√î T·∫¢ B·ªêI C·∫¢NH V√Ä NH√ÇN V·∫¨T CH√çNH ƒë√£ ƒë∆∞·ª£c t·∫°o trong ph√¢n c·∫£nh tr∆∞·ªõc ƒë√≥, KH√îNG ƒê∆Ø·ª¢C THAY ƒê·ªîI CHI TI·∫æT.
            6. T·∫§T C·∫¢ L·ªúI THO·∫†I C·ª¶A NH√ÇN V·∫¨T B·∫ÆT BU·ªòC PH·∫¢I L√Ä TI·∫æNG VI·ªÜT. L·ªùi tho·∫°i PH·∫¢I C·ª∞C K·ª≤ NG·∫ÆN G·ªåN (t·ªëi ƒëa 5-6 gi√¢y n√≥i) ƒë·ªÉ ph√π h·ª£p v·ªõi gi·ªõi h·∫°n 8 gi√¢y c·ªßa c·∫£nh quay. L·ªùi tho·∫°i ph·∫£i ƒë∆∞·ª£c ƒë∆∞a v√†o prompt d∆∞·ªõi d·∫°ng: 'A character is speaking in Vietnamese with the **FIXED VOICE ID** "[ƒê·ªãnh danh gi·ªçng n√≥i c·ªë ƒë·ªãnh, e.g., smooth young female voice with a strong Hanoian accent]" saying "[L·ªùi tho·∫°i ti·∫øng Vi·ªát ng·∫Øn g·ªçn c·ªßa nh√¢n v·∫≠t]"'. B·∫ÆT BU·ªòC ph·∫£i: T·ª± t·∫°o ra **CH√çNH X√ÅC M·ªòT CHU·ªñI K√ù T·ª∞ M√î T·∫¢ ID GI·ªåNG N√ìI DUY NH·∫§T (Fixed Voice ID)** cho nh√¢n v·∫≠t ch√≠nh (m√¥ t·∫£ √¢m s·∫Øc, cao ƒë·ªô, t·ªëc ƒë·ªô, ch·∫•t gi·ªçng) d·ª±a tr√™n m√¥ t·∫£ k·ªãch b·∫£n. S·ª≠ d·ª•ng **L·∫∂P L·∫†I CHU·ªñI K√ù T·ª∞ Fixed Voice ID N√ÄY, GI·ªêNG 100% (IDENTICAL STRING REPLICATION)**, cho nh√¢n v·∫≠t ƒë√≥ trong T·∫§T C·∫¢ c√°c ph√¢n c·∫£nh sau. **B·∫•t k·ª≥ sai l·ªách n√†o d√π ch·ªâ 1 k√Ω t·ª± c≈©ng b·ªã C·∫§M.** KH√îNG ƒê∆Ø·ª¢C T·∫†O VIDEO KH√îNG C√ì THO·∫†I V√Ä KH√îNG ƒê∆Ø·ª¢C C√ì B·∫§T C√ÅI L·ªúI THO·∫†I N√ÄO B·∫∞NG TI·∫æNG ANH D∆Ø·ªöI B·∫§T C√ÅI H√åNH TH·ª®C N√ÄO.
            7. ƒê·∫ßu ra ph·∫£i l√† m·ªôt c·∫•u tr√∫c JSON.
            8. Y√™u c·∫ßu Chi ti·∫øt v√† T√≠ch h·ª£p H√¨nh ·∫£nh (ƒê·ªô Gi·ªëng 100% B·∫ÆT BU·ªòC): N·∫æU B·ª®C ·∫¢NH HO·∫∂C NHI·ªÄU B·ª®C ·∫¢NH ƒê∆Ø·ª¢C CUNG C·∫§P, b·∫°n PH·∫¢I ph√¢n t√≠ch T·∫§T C·∫¢ c√°c b·ª©c ·∫£nh ƒë√≥, **T·ªîNG H·ª¢P V√Ä H·ª¢P NH·∫§T T·∫§T C·∫¢ C√ÅC CHI TI·∫æT QUAN S√ÅT ƒê∆Ø·ª¢C** trong ·∫£nh l√†m M√î T·∫¢ NGU·ªíN CH√çNH X√ÅC 100% (Source of Truth) cho t·∫•t c·∫£ c√°c y·∫øu t·ªë h√¨nh ·∫£nh. ƒê·∫∑c bi·ªát, b·∫°n PH·∫¢I m√¥ t·∫£ C√ÅC Y·∫æU T·ªê SAU V·ªöI T√çNH CH√çNH X√ÅC TUY·ªÜT ƒê·ªêI ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·ªô gi·ªëng 100%: (1) Ngo·∫°i h√¨nh nh√¢n v·∫≠t (t·ª´ng chi ti·∫øt nh·ªè tr√™n khu√¥n m·∫∑t, c·∫•u tr√∫c x∆∞∆°ng, ki·ªÉu t√≥c); (2) B·ªÅ m·∫∑t v√† k·∫øt c·∫•u v·∫≠t li·ªáu (texture chi ti·∫øt c·ªßa v·∫£i, g·ªó, kim lo·∫°i); (3) G√≥c m√°y v√† C·∫•u h√¨nh √°nh s√°ng (h∆∞·ªõng s√°ng, m√†u s·∫Øc √°nh s√°ng, cinematic style); (4) Trang ph·ª•c, bao g·ªìm h·ªça ti·∫øt/hoa vƒÉn v√† V·ªä TR√ç CH√çNH X√ÅC c·ªßa ch√∫ng; (5) Phong c√°ch ngh·ªá thu·∫≠t t·ªïng th·ªÉ (v√≠ d·ª•: cinematic 4K, film grain). N·∫æU KH√îNG C√ì ·∫¢NH, h√£y t·ª± t·∫°o m√¥ t·∫£ chi ti·∫øt 100% cho Rule 3.
            9. L·ªánh S·ª≠ d·ª•ng H√¨nh ·∫£nh (B·∫ÆT BU·ªòNG trong veo_prompt_en): B·∫ÆT BU·ªòC ƒë·∫∑t m·ªôt l·ªánh r√µ r√†ng v√†o ƒë·∫ßu m·ªói prompt, bao g·ªìm C·∫¢ HAI ƒëi·ªÅu ki·ªán. Prompt ti·∫øng Anh PH·∫¢I B·∫ÆT ƒê·∫¶U b·∫±ng CH√çNH X√ÅC chu·ªói l·ªánh sau: "If image(s) were provided in this query, create the video using the image(s) as the absolute source of truth for appearance, and the following description for motion and continuity. If no image was provided, create the video using the following text description as the absolute source of truth for appearance, motion, and continuity: "
            `;

        /**
         * H√†m chuy·ªÉn ƒë·ªïi m√£ HTML th√†nh chu·ªói ƒë·ªÉ hi·ªÉn th·ªã
         */
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = 0;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                const successful = document.execCommand('copy'); 
                if (successful) {
                    showMessage("ƒê√£ sao ch√©p prompt ti·∫øng Anh!", "bg-green-100 text-green-700");
                } else {
                    showMessage("L·ªói: Kh√¥ng th·ªÉ sao ch√©p t·ª± ƒë·ªông. Vui l√≤ng sao ch√©p th·ªß c√¥ng.", "bg-red-100 text-red-700");
                }
            } catch (err) {
                showMessage("L·ªói: Kh√¥ng th·ªÉ sao ch√©p t·ª± ƒë·ªông. Vui l√≤ng sao ch√©p th·ªß c√¥ng.", "bg-red-100 text-red-700");
            }
            document.body.removeChild(textarea);
        }

        /**
         * Hi·ªÉn th·ªã th√¥ng b√°o (thay th·∫ø cho alert())
         */
        function showMessage(message, style) {
            messageArea.textContent = message;
            messageArea.className = `mt-6 p-4 text-sm rounded-lg ${style}`;
            messageArea.style.display = 'block';
            
            setTimeout(() => {
                messageArea.style.display = 'none';
            }, 5000);
        }

        /**
         * Hi·ªÉn th·ªã k·∫øt qu·∫£ k·ªãch b·∫£n l√™n UI
         */
        function displayResults(result) {
            outputSection.classList.remove('hidden');
            videoTitleDisplay.innerHTML = `üé¨ T√™n Video: <span class="font-bold">${result.video_title}</span>`;
            scenesContainer.innerHTML = '';

            result.scenes.forEach(scene => {
                const sceneCard = document.createElement('div');
                sceneCard.className = 'scene-card card p-5 flex flex-col space-y-3';
                
                sceneCard.innerHTML = `
                    <div class="flex justify-between items-center pb-2 border-b border-blue-200">
                        <h3 class="text-lg font-bold text-blue-700">Ph√¢n C·∫£nh ${scene.scene_number} (${scene.duration_seconds})</h3>
                        <button class="copy-btn px-3 py-1 text-xs font-medium rounded-full text-white bg-green-500 hover:bg-green-600 transition duration-150">
                            Sao Ch√©p Prompt
                        </button>
                    </div>

                    <p class="text-gray-900">
                        <span class="font-semibold text-gray-700">K·ªãch b·∫£n (Ti·∫øng Vi·ªát):</span> 
                        <span class="block mt-1">${scene.vietnamese_script}</span>
                    </p>

                    <div class="prompt-box">
                        <span class="font-semibold text-gray-800 block mb-1">PROMPT VEO 3 (Ti·∫øng Anh - Li√™n T·ª•c 100%):</span>
                        <code class="text-sm text-gray-900 whitespace-pre-wrap block">${scene.veo_prompt_en}</code>
                    </div>
                `;
                scenesContainer.appendChild(sceneCard);
            });

            // G·∫Øn s·ª± ki·ªán sao ch√©p: l·∫•y n·ªôi dung tr·ª±c ti·∫øp t·ª´ th·∫ª <code>
            document.querySelectorAll('.copy-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const promptCodeElement = event.target.closest('.scene-card').querySelector('code');
                    if (promptCodeElement) {
                        copyToClipboard(promptCodeElement.textContent.trim());
                    } else {
                        showMessage("L·ªói: Kh√¥ng t√¨m th·∫•y n·ªôi dung prompt ƒë·ªÉ sao ch√©p.", "bg-red-100 text-red-700");
                    }
                });
            });
        }

        /**
         * X·ª≠ l√Ω logic g·ªçi API Gemini
         */
        async function generatePrompts() {
            const videoIdea = videoIdeaInput.value.trim();
            const numScenes = parseInt(numScenesInput.value);
            const imageFiles = imageUpload.files;
            
            let multimodalParts = [];

            if (!videoIdea) {
                showMessage("Vui l√≤ng nh·∫≠p t√≥m t·∫Øt √Ω t∆∞·ªüng video.", "bg-red-100 text-red-700");
                return;
            }
            if (numScenes < 1 || numScenes > 100 || isNaN(numScenes)) { 
                 showMessage("S·ªë ph√¢n c·∫£nh ph·∫£i t·ª´ 1 ƒë·∫øn 100.", "bg-red-100 text-red-700");
                return;
            }

            // --- C·∫≠p nh·∫≠t UI tr·∫°ng th√°i Loading ---
            generateBtn.disabled = true;
            btnText.textContent = "ƒêang T·∫°o K·ªãch B·∫£n...";
            loadingSpinner.classList.remove('hidden');
            outputSection.classList.add('hidden');
            messageArea.style.display = 'none';

            // 1. Chu·∫©n b·ªã Multimodal Data
            let userQuery = `D·ª±a tr√™n √Ω t∆∞·ªüng sau: "${videoIdea}", h√£y t·∫°o m·ªôt video g·ªìm ${numScenes} ph√¢n c·∫£nh. ƒê·∫£m b·∫£o tu√¢n th·ªß nghi√™m ng·∫∑t 9 quy t·∫Øc ƒë√£ cho.`; // Updated rule count
            
            // X·ª≠ l√Ω Images
            if (imageFiles.length > 0) {
                try {
                    showMessage(`ƒêang t·∫£i ${imageFiles.length} ·∫£nh l√™n v√† ph√¢n t√≠ch...`, "bg-yellow-100 text-yellow-700");
                    const promises = Array.from(imageFiles).map(file => fileToBase64(file));
                    const base64Results = await Promise.all(promises);

                    base64Results.forEach(res => {
                        multimodalParts.push({
                            inlineData: {
                                mimeType: res.mimeType,
                                data: res.data
                            }
                        });
                    });
                    
                } catch (e) {
                    console.error("L·ªói chuy·ªÉn ƒë·ªïi t·ªáp h√¨nh ·∫£nh:", e);
                    showMessage("L·ªói: Kh√¥ng th·ªÉ x·ª≠ l√Ω t·ªáp h√¨nh ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i.", "bg-red-100 text-red-700");
                    resetUI();
                    return;
                }
            } 
            
            // 2. X√¢y d·ª±ng Payload
            // ƒê·∫∑t c√°c ph·∫ßn multimodal (image) l√™n ƒë·∫ßu, sau ƒë√≥ l√† ph·∫ßn text query
            const contentsParts = [...multimodalParts, { text: userQuery }]; 
            
            const payload = {
                contents: [{ parts: contentsParts }],
                systemInstruction: { parts: [{ text: systemInstructionText }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                }
            };

            // 3. Th·ª±c hi·ªán API Call v·ªõi Exponential Backoff
            const maxRetries = 3;
            let currentRetry = 0;

            while (currentRetry < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    const candidate = result.candidates?.[0];
                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const jsonText = candidate.content.parts[0].text;
                        const parsedJson = JSON.parse(jsonText);
                        displayResults(parsedJson);
                        showMessage("T·∫°o k·ªãch b·∫£n th√†nh c√¥ng! H√£y sao ch√©p prompt ti·∫øng Anh ƒë·ªÉ t·∫°o video.", "bg-blue-100 text-blue-700");
                        return; // Th√†nh c√¥ng, tho√°t kh·ªèi v√≤ng l·∫∑p
                    } else {
                        // Th·ª≠ ph√¢n t√≠ch l·ªói JSON n·∫øu c√≥ th·ªÉ
                        throw new Error("Ph·∫£n h·ªìi t·ª´ Gemini kh√¥ng ch·ª©a n·ªôi dung h·ª£p l·ªá ho·∫∑c JSON b·ªã l·ªói.");
                    }

                } catch (error) {
                    console.error("L·ªói API/JSON:", error);
                    currentRetry++;
                    if (currentRetry < maxRetries) {
                        const delay = Math.pow(2, currentRetry) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay)); // Exponential backoff
                    } else {
                        showMessage(`L·ªói h·ªá th·ªëng: Kh√¥ng th·ªÉ t·∫°o k·ªãch b·∫£n sau ${maxRetries} l·∫ßn th·ª≠. Vui l√≤ng ki·ªÉm tra l·∫°i √Ω t∆∞·ªüng ho·∫∑c th·ª≠ l·∫°i sau.`, "bg-red-100 text-red-700");
                    }
                }
            }
            
        }

        // --- G·∫Øn s·ª± ki·ªán cho n√∫t T·∫°o ---
        generateBtn.addEventListener('click', generatePrompts);

        // --- Reset UI sau khi ho√†n th√†nh ho·∫∑c th·∫•t b·∫°i ---
        function resetUI() {
            generateBtn.disabled = false;
            btnText.textContent = "T·∫°o K·ªãch B·∫£n & Prompt";
            loadingSpinner.classList.add('hidden');
        }

        // G·∫Øn h√†m resetUI v√†o finally ƒë·ªÉ ƒë·∫£m b·∫£o UI ƒë∆∞·ª£c kh√¥i ph·ª•c d√π th√†nh c√¥ng hay th·∫•t b·∫°i
        generateBtn.addEventListener('click', async () => {
            try {
                await generatePrompts();
            } finally {
                resetUI();
            }
        });

    </script>
</body>
</html>
